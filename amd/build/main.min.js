define(["jquery","core/templates","filter_ally/ally","filter_ally/imagecover","filter_ally/util"],function(a,b,c,d,e){return new function(){var f=this;f.canViewFeedback=!1,f.canDownload=!1;var g=function(c,d,e){var g=a.Deferred();return c.canviewfeedback=f.canViewFeedback,c.candownload=f.canDownload,c.html='<span id="content-target-'+d+'"></span>',b.render("filter_ally/wrapper",c).done(function(b){a(e).after(b),a("#content-target-"+d).after(e),a("#content-target-"+d).remove(),g.resolve()}),g.promise()},h=function(b,c){var d=a.Deferred(),e=0;return a(b).each(function(){var f,h,i=function(){e===a(b).length&&d.resolve()};"a"===a(this).prop("tagName").toLowerCase()?(f=a(this).attr("href"),h="a"):(f=a(this).attr("src"),h="img");var j;j=f.indexOf("?")>-1?/pluginfile.php\/(\d*)\/(.*)(\?)/:/pluginfile.php\/(\d*)\/(.*)/;var k=f.match(j),l=k[1]+"/"+k[2];l=decodeURIComponent(l);var m=c[l];if(void 0===m)return e++,void i();var n={isimage:"img"===h,fileid:m,url:f};g(n,m,a(this)).done(function(){e++,i()})}),d.promise()},i=function(b){var c=a.Deferred();return h('.forumpost .attachedimages img[src*="pluginfile.php"]',b).done(function(){c.resolve()}),c.promise()},j=function(b){var c=a.Deferred();return e.whenTrue(function(){return a('div[id*="assign_files_tree"] .ygtvitem').length>0},10).done(function(){h('div[id*="assign_files_tree"] a[href*="pluginfile.php"]',b),c.resolve()}),c.promise()},k=function(b){var c=a.Deferred();return e.whenTrue(function(){return a(".foldertree > .filemanager .ygtvitem").length>0},10).done(function(){var a='.foldertree > .filemanager span:not(.filter-ally-wrapper) > a[href*="pluginfile.php"]';h(a,b).done(function(){c.resolve()})}),c.promise()},l=function(b){var c=a.Deferred(),d=0,e=function(){d++,d>=Object.keys(b).length&&c.resolve()};for(var f in b){var h=b[f],i=a("#module-"+f+" .activityinstance a:first-of-type"),j=i.find(".filter-ally-wrapper");if(j.length>0)return c.resolve(),c.promise();var k={isimage:!1,fileid:h,url:a(i).attr("href")};g(k,h,i).done(e)}return c.promise()},m=function(){var b=a.Deferred();if(void 0===ally_module_maps)return b.resolve(),b.promise();var c=[{mapVar:ally_module_maps.file_resources,method:l},{mapVar:ally_module_maps.assignment_files,method:j},{mapVar:ally_module_maps.folder_files,method:k},{mapVar:ally_module_maps.forum_files,method:i}];return a(document).ready(function(){var a=0,d=function(){a++,a===c.length&&b.resolve()};for(var e in c){var f=c[e];Object.keys(f.mapVar).length>0?f.method(f.mapVar).done(d):d()}}),b.promise()};this.init=function(a,b,e,g){f.canViewFeedback=e,f.canDownload=g,(e||g)&&m().done(function(){d.init(),c.init(a,b),setInterval(function(){k(ally_module_maps.folder_files)},5e3)})}}});